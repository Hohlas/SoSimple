
# Нейронная сеть на основе tensorflow для торгового робота
* [Считывание из файла и упорядочивание](#считывание-из-файла-и-упорядочивание)
* [Нормализация](#нормализация)
* [Тренировка нейронной сети](#тренировка-нейронной-сети) 

## Считывание из файла и упорядочивание
Требуется создать нейронную сеть для автоматической торговли на валютной паре XAUUSD60 путем формирования сигналов открытия позиций. Входные данные для сети содержатся в файле.
Файл представляет собой трехмерный массив таймсерию. Но содержит информацию не о барах, а о фракталах. Поэтому временной интервал между строками данных в файле будет разный. Фракталом будем называть ценовую формацию из трех бар, в которой цена меняет свое направление. Другими словами фрактал – это либо пик (когда средний бар выше предыдущего и последующего), либо впадина (когда средний бар ниже предыдущего и последующего). 
Итак, файл формируется следующим образом. При формировании на графике цены очередного фрактала в файл записывается строка. В первой ячейке строки записывается время формирования этого фрактала ‘time’. Далее записывается массив списков. Каждый элемент массива – это список, содержащий информацию об определенном фрактале. Назовем данный список ‘fractal’. Таким образом, каждая строка файла содержит ячейку со временем ‘time’ и [n] ячеек ‘fractal’ с информацией о последних [n] фракталах.
```bash
time[0] ; fractal[0,0] ; fractal[0,1]; … ; fractal[0,n]
time[1] ; fractal[1,0] ; fractal[1,1]; … ; fractal[1,n]
time[k] ; fractal[k,0] ; fractal[k,1]; … ; fractal[k,n]
```
Каждая ячейка ‘fractal[i,j]’ содержит список параметров фрактала, с разделителем ‘:’.  Структура данного списка следующая.
shift : price : direction : front : back : strong : break : reverse : power : count : impulse 
Значения данных параметров следующие.
```bash
shift(int) – сдвиг в барах относительно текущего (последнего) фрактала;
price(float) – значение цены фрактала;
direction(char) – направление разворота фрактала (1=пик, или -1=впадина);
front(float) – величина переднего фронта – движение, предшествующее фракталу; 
back(float) – величина заднего фронта – движение, последующее после фрактала;
strong(bool) – признак уникальности, т.е. данный фрактал может являться сигналом для открытия сделки с большим отношением profit/loss;
break(char) – количество раз, которое фрактал был пробит последующими ценовыми движениями;
reverse(char) – признак того, что фрактал пробил хотя бы один из предшествующих ему фракталов;
power(float) – сила (значимость, относительный рейтинг) фрактала;
count(char) – количество совпадений по значению цены с остальными фракталами (влияет на силу);
minutes(ushort) – кол-во минут с начала суток для текущего фрактала;
atr(float) – быстрый ATR в момент формирования фрактала;
impulse(float) – импульс цены (скорость разворота), который задал данный фрактал.
```
Все эти значения пересчитываются и обновляются с каждым новым фракталом, поэтому данные из файла нельзя подавать на вход нейронной сети в виде скользящего временного окна. Каждый цикл на вход нейронной сети нужно подавать всю строку (массив списков) целиком. На каждом следующем цикле полностью обновлять входные данные нейронной сети значениями новой строки.
Напиши программу на Python чтобы отсортировать каждую строку файла (массив fractal[1] ; fractal[2] ; … ; fractal[n]) по возрастанию значения ‘shift’. 
  
## Нормализация
Мы имеем переменную ‘data’ следующего вида:

```bash
17.04.2023	6:1981.1:-1:67.5:14.8:0:0:1:34.1:1:2.3	11:2010.6:1:5.7:29.5:0:0:0:34.1:2:2.3	12:1995.9:1:14.8:1.7:0:0:1:34.1:5:2.3
17.04.2023	13:2010.6:1:5.7:29.5:0:0:0:6.5:2:1.2	15:1987.2:-1:4.9:8.7:0:0:0:6.5:1:1.2	18:1981.1:-1:67.5:14.8:0:0:1:6.5:1:1.2
```

Преобразуем текст в список:

```python
for i in range(len(data)):
    for j in range(1, len(data[i])): # пропускаем первый столбец со временем
        data[i][j] = np.array(data[i][j].split(':'))
```  
получаем список списков
```bash
17.04.2023	6,1981.1,-1,67.5,14.8,0,0,1,34.1,1,2.3	11,2010.6,1,5.7,29.5,0,0,0,34.1,2,2.3	12,1995.9,1,14.8,1.7,0,0,1,34.1,5,2.3
17.04.2023	13,2010.6,1,5.7,29.5,0,0,0,6.5,2,1.2	15,1987.2,-1,4.9,8.7,0,0,0,6.5,1,1.2	18,1981.1,-1,67.5,14.8,0,0,1,6.5,1,1.2
```           
Переменная ‘data’ представляет собой список списков, и имеет следующий вид:

```python
time[0] fractal[0,0] fractal[0,1] … fractal[0,n]
time[1] fractal[1,0] fractal[1,1] … fractal[1,n]
……
time[k] fractal[k,0] fractal[k,1] … fractal[k,n]
```

В первом столбце содержится время ‘time’. Следующие столбцы представляют собой списки ‘fractal’ из 13 значений:

```python
fractal=[
shift(int)
price(float)
direction(char)
front(float)
back(float)
strong(bool)
break(char)
reverse(char)
power(float)
count(char)
minute(ushort)
atr(float)
impulse(float)
time(dtime)
]
```

В списке ‘data’ в пределах каждой строки среди списков fractal[0]...fractal[n] нужно нормализовать значения переменной shift к диапазону [0..1], значение price нормализовать к диапазону [0..1]. 
Аналогично нормализовать break, reverse, power, count, minute, atr, impulse.
Переменные front и back имеют общую единицу измерения и общие пределы (max_val, min_val), поэтому их необходимо нормализовать вместе к общему диапазону [0..1].   
При дальнейшей работе со списком ‘data’ потребуется восстановить нормализованное значение ‘price’ к исходному значению. Поэтому в список ‘data’ сразу после столбца ‘time’ нужно добавить столбец ‘recover’, содержащий данные [min_val, multiplier] для восстановления ‘price’.
Напиши код на Python, реализующий данную задачу. 

## Тренировка нейронной сети
Необходимо создать нейронную сеть для автоматической торговли на валютной паре XAUUSD60. Сеть должна формировать цены входа в позицию путем обработки массива ценовых данных. Входными данными для тренировки сети является список ‘data’, содержащий в себе 99 списков ‘fractal’. 
Фракталом будем называть ценовую формацию из трех бар, в которой цена меняет свое направление. Другими словами, фрактал - это либо пик (когда средний бар выше предыдущего и последующего), либо впадина (когда средний бар ниже предыдущего и последующего). 
При формировании на ценовом графике очередного фрактала на вход нейронной сети подается 99 списков ‘fractal’. Каждый список ‘fractal’ содержит в себе следующие 12 параметров фрактала: 
 
```bash
fractal=[shift, price, direction, front, back, strong, break, reverse, power, count, minute, atr, impulse, time] 
```

Эти параметры имеют следующие значения.
```bash
[0] shift(int) – Сдвиг в барах относительно текущего (последнего) фрактала. Все фракталы в списке ‘fractal’ упорядочены по этому значению.
[1] price(float) – Значение цены фрактала.
[2] direction(char) – Направление разворота фрактала. Принимает два значения: ‘1’-пик (разворот сверху вниз),  ‘-1’-впадина (разворот снизу вверх).
[3] front(float) – Величина переднего фронта – движение, предшествующее фракталу. Определяет размер фрактала.
[4] back(float) – Величина заднего фронта – движение, последующее после фрактала. Определяет размер фрактала
[5] strong(bool) – Признак «ключевого» фрактала, является сигналом для открытия сделки с большим отношением profit/loss;
[6] break(char) – Количество раз, которое фрактал был пробит последующими ценовыми движениями, чем больше это значение, тем фрактал считается «слабее». При отрицательных значениях имеет место «обратный пробой», что делает фрактал еще слабее.
[7] reverse(char) – Признак того, что фрактал пробил хотя бы один из предшествующих ему фракталов.
[8] power(float) – Сила (значимость, относительный рейтинг) фрактала. Формируется из нескольких признаков. Фракталы с максимальным значением ‘power’ имеют статус ‘strong’.
[9] count(char) – Количество совпадений по значению цены с остальными фракталами (влияет на параметр 'power').
[10] minutes(ushort) – Количество минут с начала суток до момента формирования фрактала.
[11] atr(float) – быстрый ATR(9) в момент формирования фрактала.
[12] impulse(float) – Импульс фрактала (скорость разворота цены).
[13] time(dtime) – Время формирования фрактала.
```
Каждое из этих значений нормализовано в диапазон [0:1], либо [-1:1] совместно с одноименными значениями в пределах всех 99 списков ‘fractal’.  
Все значения каждого из 99-ти списков ‘fractal’ пересчитываются и обновляются с каждым новым фракталом, поэтому данные из списка списков ‘data’ нельзя подавать на вход нейронной сети в виде скользящего временного окна. Каждую эпоху на вход нейронной сети должен подаваться весь список из 99-ти списков ‘fractal’ целиком. Итого, 99 списков ‘fractal’ по 12 параметров, получается, что нейронная сеть должна иметь 1188 входов.
Все фракталы в списке ‘fractal’ упорядочены по времени формирования. В начале списка (с индексом [0] и минимальным значением ‘shift’) идет самый новый, только что сформированный фрактал. В конце списка (с индексом[98] и максимальным значением ‘shift’) идет самый старый фрактал. 
Поэтому временной интервал между строками данных в файле будет разный.

Список списков ‘data’ сохранен в файл normalized.csv, каждая строка которого содержит список из 99 списков ‘fractal’. В первых столбцах каждой строки файла normalized.csv добавлены списки ‘time’, ’recover’ и ‘predict’. 
```bash
time – время формирования фрактала формата ‘DD.MM.YYYY  hh:mm:ss’
recover = [min_val, multiplier] данные для восстановления нормализованного значения цены ‘price’ из списков ‘fractal’ данной строки. 
predict=[future_status, next_strong] – метки (выходы модели).
```
```bash
future_status [bool] – статус нового фрактала с индексом [0] в будущем. 1-данный фрактал получит в будущем статус ‘strong’, т.е. от него можно открывать позицию.
next_strong[float] – значение цены ближайшего в будущем фрактала со статусом ‘strong’. Т.е. цена, по которой можно выставлять лимитный приказ на открытие позиции. Данные значения нормализованы к диапазону [0:1] вместе со значениями ‘price’ всех списков ‘fractal’ текущей строки.   
```
Входные данные и метки списка ‘data’ предварительно обработаны для модели, они нормализованы и прошли проверку на пустые значения.



